# Tool search tools MCP

![License](https://img.shields.io/github/license/fussraider/tool-search-tools-mcp)
![Node.js Version](https://img.shields.io/badge/node-%3E%3D22-blue)

[English](./README.md) | Русский

Инструмент для поиска и использования инструментов MCP. Этот проект реализует MCP-сервер, который выступает в роли агрегатора и прокси для других серверов.

## Какую проблему решает проект?

Современные LLM (например, Claude) имеют ограничение на объем контекста. Когда вы подключаете множество MCP-серверов напрямую:
1.  **Переполнение контекста**: Все описания инструментов передаются в системном промпте при каждом запросе. Если инструментов десятки или сотни, они «съедают» полезный объем контекста и увеличивают стоимость каждого сообщения.
2.  **Снижение качества ответов**: Из-за обилия доступных функций модель может путаться в выборе подходящего инструмента или игнорировать важные инструкции.
3.  **Ограничения клиентов**: Многие клиенты (например, Claude Desktop) имеют лимиты на количество одновременно активных инструментов.

**Tool search tools MCP** решает эти проблемы, работая по принципу «инструмент для инструментов»:
*   Он скрывает все реальные инструменты за двумя универсальными: `search_tools` и `call_tool`.
*   Модель видит только эти два инструмента, что оставляет контекст чистым.
*   Когда модели что-то нужно, она сначала ищет подходящий инструмент по ключевым словам, получает его схему и затем вызывает его через прокси.

## Основные возможности

*   **Агрегация**: Доступ к инструментам из разных MCP-серверов (например, filesystem, git, sqlite) через один сервер.
*   **Умный поиск**: Специальный инструмент `search_tools` для фильтрации доступных функций. Использует нечеткий поиск (fuzzy search) и учитывает названия, описания и параметры инструментов.
*   **Генерация ключевых слов**: Автоматическое извлечение ключевых слов из определений инструментов для повышения точности поиска.
*   **Гибридный поиск**: Поддержка как нечеткого поиска (`fuse.js`), так и семантического векторного поиска (`transformers.js`) для лучшего понимания намерений пользователя.
*   **Экономия контекста**: Вместо сотен инструментов модель видит всего два, что критически важно для длинных диалогов.
*   **Мультиязычность**: Улучшенная обработка текста с поддержкой кириллицы и других символов.
*   **Кэширование эмбеддингов**: Персистентное хранилище для векторов инструментов, что обеспечивает быстрый запуск и минимизирует нагрузку на CPU.
*   **Динамический вызов**: Инструмент `call_tool` для выполнения команд найденных серверов.
*   **Улучшенное логирование**: Поддержка вывода в файл, логирование по областям (scopes) и детальная настройка уровней.
*   **Безопасность**: Валидация ответов от подключаемых серверов с использованием Zod.

## Установка

1.  Клонируйте репозиторий.
2.  Установите зависимости:
    ```bash
    pnpm install # или npm install, yarn
    ```

## Использование

### Запуск сервера

Для разработки (с автоматической перезагрузкой):
```bash
pnpm dev # или npm run dev, yarn dev
```

Для использования (сборка и запуск):
```bash
pnpm build # или npm run build, yarn build
pnpm start # или npm start, yarn start
```

### CLI утилита для тестирования

Вы можете протестировать поиск инструментов напрямую из командной строки:

```bash
pnpm search_tools "list directory contents"
```

Эта команда подключится ко всем серверам, описанным в вашем `mcp-config.json`, загрузит их инструменты и выведет результаты поиска прямо в терминал.

### Подключение к Claude Desktop или другим клиентам
Добавьте этот сервер в конфигурацию вашего MCP-клиента. Например, для Claude Desktop:

#### Способ 1: С использованием Node.js (рекомендуется)
```json
{
  "mcpServers": {
    "tool-search-tools-mcp": {
      "command": "node",
      "args": [
        "/path/to/tool-search-tools-mcp/dist/server.js"
      ],
      "env": {
        "MCP_CONFIG_PATH": "/path/to/your/mcp-config.json",
        "MCP_SEARCH_MODE": "vector"
      }
    }
  }
}
```

#### Способ 2: С использованием tsx (для разработки)
```json
{
  "mcpServers": {
    "tool-search-tools-mcp": {
      "command": "npx",
      "args": [
        "tsx",
        "/path/to/tool-search-tools-mcp/src/server.ts"
      ],
      "env": {
        "MCP_CONFIG_PATH": "/path/to/your/mcp-config.json",
        "MCP_SEARCH_MODE": "vector"
      }
    }
  }
}
```

## Настройка
Список подключаемых серверов настраивается в файле `mcp-config.json` в корне проекта или по пути, указанному в переменной окружения `MCP_CONFIG_PATH`.

### Пример `mcp-config.json`
```json
{
  "mcpServers": {
    "filesystem": {
      "command": "npx",
      "args": ["@modelcontextprotocol/server-filesystem", "/your/path"],
      "env": {
        "SOME_VAR": "value"
      }
    }
  }
}
```

### Переменные окружения
*   `MCP_CONFIG_PATH`: Путь к файлу конфигурации (по умолчанию `mcp-config.json` в директории проекта).
*   `LOG_LEVEL`: Уровень логирования (`DEBUG`, `INFO`, `WARN`, `ERROR`). По умолчанию `INFO`.
*   `LOG_FILE_PATH`: Путь к файлу для записи логов. Если не задан, логи выводятся в `stderr`.
*   `LOG_SHOW_TIMESTAMP`: Включает отображение даты и времени в логах. По умолчанию `false`. Поддерживаемые значения для включения: `true`, `1`, `yes` (регистронезависимо).
*   `MCP_SEARCH_MODE`: Режим поиска. Варианты: `fuse` (по умолчанию) или `vector` (семантический поиск).
*   `MCP_EMBEDDING_MODEL`: Модель, используемая для генерации эмбеддингов. По умолчанию: `Xenova/all-MiniLM-L6-v2`.
*   `MCP_CACHE_DIR`: Директория для хранения кэшированных эмбеддингов. По умолчанию: `.cache/embeddings`.

## Устранение неполадок

### Проблемы с установкой `sharp`
Проект использует `transformers.js`, который зависит от библиотеки `sharp`. На некоторых системах (особенно macOS Apple Silicon) `pnpm` может блокировать установку нативных зависимостей из соображений безопасности. Если вы видите ошибки, связанные с `sharp`, убедитесь, что вы используете актуальный `package.json` с разделом `pnpm.onlyBuiltDependencies`, или выполните:
```bash
pnpm install
```
Если проблема сохраняется, может потребоваться явно разрешить сборку зависимостей или переустановить их:
```bash
rm -rf node_modules pnpm-lock.yaml
pnpm install
```

## Структура проекта

*   `src/server.ts` — Основной файл MCP-сервера. Точка входа, инициализирующая сервер и внутренние инструменты.
*   `src/mcp/` — Логика работы с MCP:
    *   `registry.ts` — Управление подключениями к другим серверам, извлечение инструментов и генерация ключевых слов для поиска.
    *   `search.ts` — Алгоритм нечеткого поиска с использованием `fuse.js` и семантический векторный поиск.
    *   `executor.ts` — Логика проксирования вызовов инструментов подключенных серверов.
*   `src/utils/` — Утилиты:
    *   `logger.ts` — Кастомный логгер с поддержкой вывода в файл и уровней логирования.
    *   `embeddings.ts` — Сервис для генерации и кэширования векторных эмбеддингов.
    *   `text.ts` — Утилиты для нормализации и обработки текста.
*   `mcp-config.json` — Файл конфигурации со списком подключенных MCP-серверов.

## Лицензия

MIT
